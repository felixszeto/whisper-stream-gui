<!DOCTYPE html>
<html>
<head>
    <title>Whisper Stream GUI</title>
    <link rel="stylesheet" href="css/bulma.min.css">
    <style>
        body {
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
        }
        .select {
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px; /* Add some spacing between select and buttons */
            align-items: baseline;
            margin-left: auto;
        }
        .buttons {
            display: flex;
            vertical-align: middle;
        }
        #chat-container {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            word-wrap: break-word;
            transition: all 0.3s;
        }
        .user-message {
            background-color: #e0f7fa;
            align-self: flex-end;
            text-align: right;
        }

        .recording-message {
            background-color: #fcffd2;
        }
        .server-message {
            background-color: #f0f0f0;
            align-self: flex-start;
            text-align: left;
        }
        .message-content {
            margin-top: 5px;
        }
        .loading-status {
            opacity: 0.7; /* 降低透明度 */
            transition: all 0.3s;
        }

        .skeleton-line {
            width: 160px;
            height: 12px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s linear infinite;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        
        .skeleton-line.long {
            width: 240px;
        }

        .skeleton-line.short {
            width: 80px;
        }

        .skeleton-line.large {
            width: 70vw;
            height: 12px;
        }

        .skeleton-line.huge {
            width: 80vw;
            height: 12px;
        }

        #recordButton {
            margin-right: 10px;
            margin-bottom: 0px;
        }

        #stopButton {
            margin-right: 10px;
            margin-bottom: 0px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
    </style>
</head>
<body>
    <section class="section">
        <div class="container">
            <h1 class="title is-2">Whisper Stream GUI</h1>
            <div class="buttons">
                <button id="recordButton" class="button is-primary">
                    <span class="icon">
                        <i class="fas fa-microphone"></i>
                    </span>
                    <span>Start Recording</span>
                </button>
                <button id="stopButton" class="button is-danger" disabled>
                    <span class="icon">
                        <i class="fas fa-stop"></i>
                    </span>
                    <span>Stop Recording</span>
                </button>
                <div class="select">
                    <select id="languageSelect">
                        <option value="af">Afrikaans</option>
                        <option value="am">Amharic</option>
                        <option value="ar">Arabic</option>
                        <option value="as">Assamese</option>
                        <option value="az">Azerbaijani</option>
                        <option value="ba">Bashkir</option>
                        <option value="be">Belarusian</option>
                        <option value="bg">Bulgarian</option>
                        <option value="bn">Bengali</option>
                        <option value="bo">Tibetan</option>
                        <option value="bs">Bosnian</option>
                        <option value="br">Breton</option>
                        <option value="ca">Catalan</option>
                        <option value="cs">Czech</option>
                        <option value="cy">Welsh</option>
                        <option value="da">Danish</option>
                        <option value="de">German</option>
                        <option value="el">Greek</option>
                        <option value="en">English</option>
                        <option value="es">Spanish</option>
                        <option value="et">Estonian</option>
                        <option value="eu">Basque</option>
                        <option value="fa">Persian</option>
                        <option value="fi">Finnish</option>
                        <option value="fo">Faroese</option>
                        <option value="fr">French</option>
                        <option value="gl">Galician</option>
                        <option value="gu">Gujarati</option>
                        <option value="ha">Hausa</option>
                        <option value="haw">Hawaiian</option>
                        <option value="he">Hebrew</option>
                        <option value="hi">Hindi</option>
                        <option value="hr">Croatian</option>
                        <option value="hu">Hungarian</option>
                        <option value="hy">Armenian</option>
                        <option value="id">Indonesian</option>
                        <option value="is">Icelandic</option>
                        <option value="it">Italian</option>
                        <option value="ja">Japanese</option>
                        <option value="jw">Javanese</option>
                        <option value="ka">Georgian</option>
                        <option value="kk">Kazakh</option>
                        <option value="km">Khmer</option>
                        <option value="kn">Kannada</option>
                        <option value="ko">Korean</option>
                        <option value="la">Latin</option>
                        <option value="lb">Luxembourgish</option>
                        <option value="ln">Lingala</option>
                        <option value="lo">Lao</option>
                        <option value="lt">Lithuanian</option>
                        <option value="lv">Latvian</option>
                        <option value="mg">Malagasy</option>
                        <option value="mi">Maori</option>
                        <option value="mk">Macedonian</option>
                        <option value="ml">Malayalam</option>
                        <option value="mn">Mongolian</option>
                        <option value="mr">Marathi</option>
                        <option value="ms">Malay</option>
                        <option value="mt">Maltese</option>
                        <option value="my">Myanmar</option>
                        <option value="ne">Nepali</option>
                        <option value="nl">Dutch</option>
                        <option value="nn">Nynorsk</option>
                        <option value="no">Norwegian</option>
                        <option value="oc">Occitan</option>
                        <option value="pa">Punjabi</option>
                        <option value="pl">Polish</option>
                        <option value="ps">Pashto</option>
                        <option value="pt">Portuguese</option>
                        <option value="ro">Romanian</option>
                        <option value="ru">Russian</option>
                        <option value="sa">Sanskrit</option>
                        <option value="sd">Sindhi</option>
                        <option value="si">Sinhala</option>
                        <option value="sk">Slovak</option>
                        <option value="sl">Slovenian</option>
                        <option value="sn">Shona</option>
                        <option value="so">Somali</option>
                        <option value="sq">Albanian</option>
                        <option value="sr">Serbian</option>
                        <option value="su">Sundanese</option>
                        <option value="sv">Swedish</option>
                        <option value="sw">Swahili</option>
                        <option value="ta">Tamil</option>
                        <option value="te">Telugu</option>
                        <option value="tg">Tajik</option>
                        <option value="th">Thai</thai>
                        <option value="tk">Turkmen</option>
                        <option value="tl">Tagalog</option>
                        <option value="tt">Tatar</option>
                        <option value="uk">Ukrainian</option>
                        <option value="ur">Urdu</option>
                        <option value="uz">Uzbek</option>
                        <option value="vi">Vietnamese</option>
                        <option value="yi">Yiddish</option>
                        <option value="yo">Yoruba</option>
                        <option value="yue" selected>粵語</option>
                        <option value="zh">中文</option>
                    </select>
                </div>
            </div>

            

            <div id="chat-container">
                <div class="message server-message guide">
                    <p>
                        <div class="skeleton-line huge"></div>
                        <div class="skeleton-line huge"></div>
                    </p>
                </div>
            </div>
        </div>
    </section>
    <script src="js/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script>
        const socket = io();
        let audioContext;
        let scriptProcessor;
        let recording = false;
        let lastSentTime = 0; // 初始化 lastSentTime
        const recordButton = document.getElementById('recordButton');
        const stopButton = document.getElementById('stopButton');
        const chatContainer = document.getElementById('chat-container');

        recordButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopRecording);

        setTimeout(() => {
            chatContainer.querySelector('.guide').innerHTML = "<p>Click the \"Start Recording\" button to start recording your voice, and the transcription will be displayed here in real-time.</p>";
        }, 500); // 0.5 秒後顯示歡迎消息
        

        async function startRecording() {
            if (recording) return;
            recording = true;
            recordButton.classList.add('is-loading');
            recordButton.disabled = true;
            stopButton.disabled = false;
            chatContainer.innerHTML = ''; // 清空聊天容器
            showWelcomeMessage()
            showRecordingMessage();

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new AudioContext({ sampleRate: 16000 });
                const source = audioContext.createMediaStreamSource(stream);
                scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
                let audioBuffer = [];
                scriptProcessor.onaudioprocess = function(event) {
                    if (!recording) return;
                    const audioData = event.inputBuffer.getChannelData(0);
                    audioBuffer.push(...audioData);
                };

                let messageIndex = 0; // 消息索引
                setInterval(() => {
                    if (recording) {
                        if (audioBuffer.length > 0) {
                            // 只取最近一秒的音頻數據 (sampleRate 假設為 16000)
                            const samplesPerSecond = audioContext.sampleRate;
                            const audioSegment = audioBuffer.splice(-samplesPerSecond); // 從 buffer 尾部取出
                            if (audioSegment.length > 0) {
                                const audioInt16 = audioSegment.map(floatTo16BitPCM);
                                const audioBytes = new Int16Array(audioInt16).buffer;
                                const audioBase64 = btoa(String.fromCharCode.apply(null, new Uint8Array(audioBytes)));
                                const language = document.getElementById('languageSelect').value; // 獲取選取的語言
                                socket.emit('audio_stream', { audio_data: audioBase64, index: messageIndex, language: language }); // 發送消息索引和語言
                                messageIndex++;
                            }
                        } else {
                            // 如果 buffer 為空，也發送空數據，告知伺服器目前無聲音
                            const language = document.getElementById('languageSelect').value; // 獲取選取的語言
                            socket.emit('audio_stream', { audio_data: "", index: messageIndex, language: language }); // 發送消息索引和語言
                            messageIndex++;
                        }
                    }
                }, 1000); // 每秒觸發一次

                source.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);
                audioContext.resume();

            } catch (error) {
                console.error('麥克風存取錯誤:', error);
                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.classList.add('message', 'server-message');
                errorMessageDiv.textContent = '麥克風存取錯誤，請檢查權限。';
                chatContainer.appendChild(errorMessageDiv);
                recordButton.classList.remove('is-loading');
                recordButton.disabled = false;
                stopButton.disabled = true;
                recording = false;
            }
        }

        function stopRecording() {
            if (!recording) return;
            recording = false;
            recordButton.classList.remove('is-loading');
            recordButton.disabled = false;
            stopButton.disabled = true;
            // 停止錄音時，移除 "聆聽中..." 的訊息，可以改成顯示 "已停止錄音" 或其他
            const userMessageDiv = chatContainer.lastElementChild;
            if (userMessageDiv && userMessageDiv.classList.contains('user-message')) {
                userMessageDiv.innerHTML = '<p>已停止錄音</p>';
            }
            if (scriptProcessor) {
                scriptProcessor.disconnect();
            }
            if (audioContext) {
                audioContext.suspend();
                audioContext.close();
            }
        }

        let messageQueue = {}; // 消息隊列
        socket.on('transcription', function(data) {
            messageQueue[data.index] = data.text; // 存入消息隊列
            displayMessagesInOrder(); // 嘗試按順序顯示消息
        });

        socket.on('loading', function(data) {
            if (data.status) {
                showSendedMessage();
                showLoading(data.audio_length);
            } else {
                changeBackToRecordingMessage();
                hideLoading();
            }
        });

        function displayMessagesInOrder() {

            const messageIndices = Object.keys(messageQueue).sort((a, b) => parseInt(a) - parseInt(b)); // 獲取排序的消息索引
            let displayedCount = 0;
            messageIndices.forEach(index => {
                if (messageQueue[index]) {
                    const serverMessageDiv = chatContainer.lastElementChild;
                    serverMessageDiv.classList.remove('loading-status');
                    serverMessageDiv.classList.add('message', 'server-message');
                    serverMessageDiv.textContent = messageQueue[index];
                    chatContainer.appendChild(serverMessageDiv);
                    delete messageQueue[index]; // 從隊列中移除已顯示的消息
                    displayedCount++;
                }
            });
            showRecordingMessage(); // 顯示 "聆聽中..." 的訊息
            chatContainer.scrollTop = chatContainer.scrollHeight; // 滾動到底部
        }

        function showLoading(audio_length){
            const serverMessageDiv = document.createElement('div');
            serverMessageDiv.classList.add('message', 'server-message', 'loading-status');
            const skeletonLineDiv = document.createElement('div');
            skeletonLineDiv.classList.add('skeleton-line');
            if (audio_length < 20000) {
                skeletonLineDiv.classList.add('short');
            }else if(audio_length > 40000){
                skeletonLineDiv.classList.add('long');
            }
            serverMessageDiv.appendChild(skeletonLineDiv);
            chatContainer.appendChild(serverMessageDiv);
        }

        function hideLoading(){
            const loadingMessageDiv = chatContainer.querySelector('.loading-status');
            if (loadingMessageDiv) {
                loadingMessageDiv.remove();
            }
        }

        function showWelcomeMessage() {
            const serverMessageDiv = document.createElement('div');
            serverMessageDiv.classList.add('message', 'server-message', 'skeleton-line', 'large');
            chatContainer.appendChild(serverMessageDiv);

            setTimeout(()=>{
                serverMessageDiv.classList.remove('skeleton-line', 'large');
                serverMessageDiv.innerHTML = "<p>Welcome to stream transcription service, start speaking to get real-time transcription!</p>"
            }, 500)
        }

        function showRecordingMessage() {
            const userMessageDiv = document.createElement('div');
            userMessageDiv.classList.add('message', 'user-message', 'recording-message');
            userMessageDiv.innerHTML = '<p>Recording...</p>';
            chatContainer.appendChild(userMessageDiv);
        }

        function showSendedMessage() {
            const userMessageDiv = chatContainer.lastElementChild;
            userMessageDiv.classList.remove('recording-message');
            userMessageDiv.innerHTML = '<p>Sent <i class="fa-regular fa-paper-plane"></i></p>';
        }

        function changeBackToRecordingMessage() {
            const userMessageDiv = chatContainer.lastElementChild;
            userMessageDiv.classList.add('recording-message');
            userMessageDiv.innerHTML = '<p>Recording...</p>';
        }

        function floatTo16BitPCM(sample) {
            let s = Math.max(-1, Math.min(1, sample));
            return s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
    </script>
</body>
</html>
